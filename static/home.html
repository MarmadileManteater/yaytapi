<html>
  <head>
    <title>yaytapi</title>
    <meta charset="UTF-8" />
    <link rel="icon" href="/static/icon.ico" />
    <style>
      body {
        font-family: 'Consolas', monospace;
        height: 100vh;
        overflow: hidden;
      }
      textarea { 
        width: 100%;
        min-height: 300px;
        max-width: 100%;
        min-width: 100%;
        border: none;
        outline: 0;
        background-color: white;
      }
      .dark {
        display: none;
      }
      button#archiveThisButton {
        display: inline-block;
        width: 100%;
        padding: 10px;
        margin-top: 20px;
        font-family: 'Segoe UI Emoji';
        background-color: brown;
        color: white;
        border: none;
        cursor: pointer;
      }
      progress {
        display: block;
        width: 100%;
        outline: none;
        border: none;
        background-color: #313131;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      progress::-moz-progress-bar, progress::-webkit-progress-value {
        background: brown;
        background-image: linear-gradient( -45deg, rgba(255, 255, 255, .2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .2) 75%, transparent 75%, transparent );
        transition: width 0.25s ease;
      }

      @media(prefers-color-scheme: dark) {
        body {
          color: white;
          background-color: black;
        }
        textarea {
          color: white;
          background-color: black;
        }
        .light {
          display: none;
        }
        .dark {
          display: initial;
        }
        a {
          color: white;
        }
      }
    </style>
  </head>
  <body>
    <div style="display: flex; gap: 15px; height: 100vh; overflow: hidden">
      <div>
        <a href="https://github.com/MarmadileManteater/yaytapi" target="_blank" rel="noreferrer" ><img src="/static/icon.png" width="200" /></a>
        <div style="text-align: center" >
          <a href="https://github.com/MarmadileManteater/yaytapi"  target="_blank" rel="noreferrer" >view source &raquo;</a>
        </div>
        <div id="archiveProgress" style="padding-top: 10px;"></div>

        <button id="archiveThisButton" style="display: none;" onclick="archiveThis()">ðŸ—„Archive this!</button>
      </div>
      <div style="display:flex; flex-direction: column; flex: 1">
        <div id="loading" style="display:flex; display: none" >
          <img class="light" src="/static/loading.gif" />
          <img class="dark" src="/static/loading-dark.gif" />
        </div>
        <h1 id="title" style="margin-top: 0; margin-bottom: 10px" ></h1>
        <textarea style="flex: 1" id="response" disabled></textarea>
      </div>
    </div>
    <script>
      ;(async () => {
        let id = ''
        window.archiveThis = async function () {
          await fetch(`/api/v1/archive_video?video_id=${id}`)
          setTimeout(async () => {
            await window.check_archive_progress()
          }, 1000)
        }
        const title = document.getElementById("title")
        const response = document.getElementById("response")
        const loading = document.getElementById("loading")
        const archiveThisButton = document.getElementById("archiveThisButton")
        const archiveProgress = document.getElementById("archiveProgress")
        console.log(archiveProgress)
        loading.style.display = 'block'
        try {
          const path = window.location.href.split(window.location.hostname)[1]
          let reqType = 'stats'
          let apiPath = '/api/v1/stats'
          if (path.startsWith('/watch?v=')) {
            reqType = 'video'
            id = path.split('/watch?v=')[1]
            apiPath = `/api/v1/videos/${id}`
            if (apiPath.indexOf("&") !== -1) {
              apiPath = apiPath.split("&")[0]
            }
          } else if (path.startsWith('/playlist?list=')) {
            reqType = 'playlist'
            id = path.split('/playlist?list=')[1]
            apiPath = `/api/v1/playlists/${id}`
            if (apiPath.indexOf("&") !== -1) {
              apiPath = apiPath.split("&")[0]
            }
          }
          apiPath = `${apiPath}?pretty=1`
          const result = await Promise.race([fetch(apiPath), new Promise((resolve, reject) => setTimeout(() => { reject({ message: "â³ Request to API endpoint timed out . . . " }) }, 10 * 1000))]);

          const statsText = await (result).text()
          if (reqType === "video") {
            let stats = JSON.parse(statsText);
            window.check_archive_progress = async function (check_for_archive_button = true) {
              let archive_progress = await Promise.all(stats.formatStreams.map(({itag}) => itag).map(async (itag) => {
                let response = await fetch(`/api/v1/check_archive_progress?video_id=${stats.videoId}&itag=${itag}`)
                if (response.status == 200) {
                  // there is progress to show
                  return [itag, await response.text()]
                } else {
                  return null
                }
              }));
              const filtered = archive_progress.filter((entry) => entry !== null)
              if (filtered.length === 0) {
                // no archive exists yet
                if (check_for_archive_button)
                  archiveThisButton.style.display = 'inline-block'
              } else if (filtered.filter((entry) => entry.progress !== 1).length > 0) {
                archiveThisButton.style.display = 'none'
                const progresses = []
                filtered.forEach(([itag, progressItem]) => {
                  const progress = JSON.parse(progressItem).progress
                  progresses.push(progress)
                  let progressElement = archiveProgress.querySelector(`#progress-${itag}`)
                  let progressLabel = archiveProgress.querySelector(`[data-for="progress-${itag}"]`)
                  if (progressElement === null) {
                    progressElement = document.createElement("progress")
                    progressElement.setAttribute("id", `progress-${itag}`)
                    progressElement.setAttribute("max", "100")
                    progressLabel = document.createElement("label")
                    progressLabel.setAttribute("data-for", `progress-${itag}`)
                    archiveProgress.appendChild(progressLabel)
                    archiveProgress.appendChild(progressElement)
                  }
                  progressElement.setAttribute("value", `${Math.floor(progress * 100)}`)
                  progressLabel.innerHTML = `itag: ${itag}, progress: ${Math.floor(progress * 100)}%`
                })
                if (progresses.filter(i => i !== 1).length !== 0) {
                  setTimeout(async () => {
                    await window.check_archive_progress(false)
                  }, 2000)
                }
              }
            }
            await window.check_archive_progress()
          }
          if (result.status !== 200) 
            throw stats
          response.value = statsText
          title.innerHTML = "ðŸŽ‰ yaytapi is running!"
        } catch (error) {
          if (typeof error === "string") {
            try {
              error = JSON.parse(error)
            } catch {
              // pass
            }
          }
          
          if (JSON.stringify(error) === "{}" && 'message' in error) {
            error = { message: error.message }
          }
          response.value = JSON.stringify(error, null, 2)
          title.innerHTML = "ðŸ¤• something is wrong!"
        }
        loading.style.display = 'none'
      })()
    </script>
  </body>
</html>
